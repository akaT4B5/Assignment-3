<%- include('../partials/header') %>
<!-- Add Session View -->
<main class="container">
    <div class="form-container">
        <h2>Log a New Session</h2>
        <!-- Form to add a new workout session -->
        <form method="POST" action="/sessions/add">
            
            <div class="session-meta" style="display: flex; gap: 20px; margin-bottom: 30px; flex-wrap: wrap;">
                <div class="form-group" style="flex: 1; min-width: 200px;">
                    <label for="date">Session Date:</label>
                    <input type="date" id="date" name="date" required>
                </div>
                <div class="form-group" style="flex: 1; min-width: 200px;">
                    <label for="focus">Session Focus:</label>
                    <input type="text" id="focus" name="focus" placeholder="e.g., Upper Body" required>
                </div>
            </div>

            <h3>Exercises</h3>
            <div id="exercises-container">
            </div>
<!-- Add Exercise Button -->
            <button type="button" id="add-exercise-btn" style="background-color: #6c757d; color: white; padding: 10px; border: none; border-radius: 5px; margin-bottom: 20px; cursor: pointer; width: 100%;">
                + Add Another Exercise
            </button>

            <hr>
            <!-- Submit and Cancel Buttons -->
            <button type="submit" class="btn-submit">Save Session & Finish</button>
            <a href="/sessions" class="btn-cancel">Cancel (Don't Save)</a>
        </form>
    </div>
</main>
<!-- JavaScript to handle dynamic exercise rows -->
<script>
    // Cache DOM references for the container and add button.
    const container = document.getElementById('exercises-container');
    const addBtn = document.getElementById('add-exercise-btn');

    // Generates a new HTML block for an exercise and appends it to the form.
    function addRow() {
        const div = document.createElement('div');
        div.className = 'exercise-row';
        // Applies inline styling to frame the row as a distinct card.
        div.style.cssText = "background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ddd; position: relative;";
        
        // Inject HTML structure. 'names[]' syntax allows Express to parse these as arrays.
        div.innerHTML = `
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <h4 style="margin:0; color: #777;">Exercise Details</h4>
                <button type="button" onclick="removeRow(this)" class="btn-delete">Remove</button>
            </div>

            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <input type="text" name="names[]" placeholder="Exercise Name (e.g. Squat)" required style="flex: 3;">
                
                <select name="types[]" onchange="toggleFields(this)" style="flex: 1;">
                    <option value="strength">Strength</option>
                    <option value="cardio">Cardio</option>
                </select>
            </div>

            <div class="strength-fields" style="display: flex; gap: 10px;">
                <input type="number" name="sets[]" placeholder="Sets" style="flex: 1;">
                <input type="number" name="reps[]" placeholder="Reps" style="flex: 1;">
                <input type="number" name="weights[]" placeholder="Weight (lbs)" style="flex: 1;">
                
                <input type="hidden" name="distances[]" value="0">
                <input type="hidden" name="durations[]" value="0">
            </div>

            <div class="cardio-fields hidden" style="display: flex; gap: 10px;">
                <input type="number" name="distances[]" placeholder="Distance (km)" style="flex: 1;" disabled>
                <input type="number" name="durations[]" placeholder="Time (min)" style="flex: 1;" disabled>
                
                <input type="hidden" name="sets[]" value="0" disabled>
                <input type="hidden" name="reps[]" value="0" disabled>
                <input type="hidden" name="weights[]" value="0" disabled>
            </div>
        `;
        container.appendChild(div);
    }

    // Finds the closest parent container with class 'exercise-row' and deletes it.
    function removeRow(btn) {
        btn.closest('.exercise-row').remove();
    }

    // Handles logic for switching between Strength and Cardio inputs.
    function toggleFields(selectElement) {
        // Identify the specific row being modified.
        const row = selectElement.closest('.exercise-row');
        const strengthGroup = row.querySelector('.strength-fields');
        const cardioGroup = row.querySelector('.cardio-fields');

        if (selectElement.value === 'cardio') {
            // SWITCH TO CARDIO
            // Update Visibility
            strengthGroup.classList.add('hidden');
            cardioGroup.classList.remove('hidden');

            // Disable ALL Strength inputs (Real + Hidden). Disabled inputs are not sent to server.
            strengthGroup.querySelectorAll('input:not([type="hidden"])').forEach(el => el.disabled = true);
            strengthGroup.querySelectorAll('input[type="hidden"]').forEach(el => el.disabled = true);

            // Enable ALL Cardio inputs (Real + Hidden).
            cardioGroup.querySelectorAll('input:not([type="hidden"])').forEach(el => el.disabled = false);
            cardioGroup.querySelectorAll('input[type="hidden"]').forEach(el => el.disabled = false);

        } else {
            // SWITCH TO STRENGTH
            // Update Visibility
            cardioGroup.classList.add('hidden');
            strengthGroup.classList.remove('hidden');

            // Enable Strength inputs.
            strengthGroup.querySelectorAll('input:not([type="hidden"])').forEach(el => el.disabled = false);
            strengthGroup.querySelectorAll('input[type="hidden"]').forEach(el => el.disabled = false);

            // Disable Cardio inputs.
            cardioGroup.querySelectorAll('input:not([type="hidden"])').forEach(el => el.disabled = true);
            cardioGroup.querySelectorAll('input[type="hidden"]').forEach(el => el.disabled = true);
        }
    }

    // Add listener to button and create one default row on page load.
    addBtn.addEventListener('click', addRow);
    addRow(); 
</script>